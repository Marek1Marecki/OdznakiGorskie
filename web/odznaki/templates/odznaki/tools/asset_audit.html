{# odznaki/templates/odznaki/tools/asset_audit.html #}
{% extends "odznaki/base.html" %}
{% block title %}Narzędzie: Audyt Plików{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="p-5 mb-4 bg-light rounded-3">
        <div class="container-fluid py-5">
            <h1 class="display-5 fw-bold">Audyt Integralności Plików</h1>
            <p class="col-md-8 fs-4">
                To narzędzie weryfikuje, czy pliki (obrazki, PDF, GPX) powiązane z obiektami w bazie danych
                faktycznie istnieją na dysku serwera.
            </p>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">1. Wybierz kategorie do przeskanowania</h5>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <div class="row">
                    {% for key, name in scan_options.items %}
                    <div class="col-md-6">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" name="models_to_scan" value="{{ key }}" id="check-{{ key }}">
                            <label class="form-check-label" for="check-{{ key }}">{{ name }}</label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <hr>
                <button type="submit" class="btn btn-primary">Uruchom Audyt</button>
            </form>
        </div>
    </div>

    {# --- NOWA SEKCJA: WYNIKI AUDYTU --- #}
    {% if audit_results is not None %} {# Sprawdzamy, czy audyt został uruchomiony #}
    <hr class="my-5">
    <div id="results">
        <h2 class="mb-3">Wyniki Audytu</h2>
        
        <div class="alert {% if total_problems_count > 0 %}alert-warning{% else %}alert-success{% endif %}">
            Przeskanowano <strong>{{ selected_options|length }}</strong> wybrane kategorie.
            Znaleziono łącznie <strong>{{ total_problems_count }}</strong> problemów.
        </div>

        {% for category_name, problems in audit_results.items %}
            <div class="card mb-4">
                <div class="card-header {% if problems %}bg-warning{% else %}bg-success text-white{% endif %}">
                    <h5 class="mb-0">
                        {% if not problems %}✔️{% else %}⚠️{% endif %}
                        {{ category_name }} - Znaleziono {{ problems|length }} problemów
                    </h5>
                </div>
                {% if problems %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Nazwa Obiektu</th>
                                    <th>Pole</th>
                                    <th>Oczekiwana Ścieżka Pliku</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for problem in problems %}
                                <tr>
                                    <td>
                                        <a href="{{ problem.edit_url }}" target="_blank" class="app-link fw-bold">
                                            {{ problem.object_name }}
                                        </a>
                                    </td>
                                    <td><code>{{ problem.field_name }}</code></td>
                                    <td><code>{{ problem.missing_path }}</code></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>
    {% endif %}
    {# --- KONIEC SEKCJI WYNIKÓW --- #}    
</div>
{% endblock %}